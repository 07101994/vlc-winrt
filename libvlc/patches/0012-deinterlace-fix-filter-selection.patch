From d37bd9c981f0f9ef05b447aac60f217029b1b8b2 Mon Sep 17 00:00:00 2001
From: Steve Lhomme <robux4@videolabs.io>
Date: Mon, 3 Jul 2017 10:15:33 +0200
Subject: [PATCH 12/12] deinterlace: fix filter selection

Apply the filter setting *after* initializing the context.
---
 modules/video_filter/deinterlace/deinterlace.c | 4 ++--
 modules/video_output/win32/d3d11_deinterlace.c | 4 ++--
 modules/video_output/win32/dxva2_deinterlace.c | 4 ++--
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/modules/video_filter/deinterlace/deinterlace.c b/modules/video_filter/deinterlace/deinterlace.c
index d028834..1397aed 100644
--- a/modules/video_filter/deinterlace/deinterlace.c
+++ b/modules/video_filter/deinterlace/deinterlace.c
@@ -318,13 +318,13 @@ notsupp:
 
     p_sys->chroma = chroma;
 
+    InitDeinterlacingContext( &p_sys->context );
+
     config_ChainParse( p_filter, FILTER_CFG_PREFIX, ppsz_filter_options,
                        p_filter->p_cfg );
     char *psz_mode = var_InheritString( p_filter, FILTER_CFG_PREFIX "mode" );
     SetFilterMethod( p_filter, psz_mode, packed );
 
-    InitDeinterlacingContext( &p_sys->context );
-
     IVTCClearState( p_filter );
 
 #if defined(CAN_COMPILE_C_ALTIVEC)
diff --git a/modules/video_output/win32/d3d11_deinterlace.c b/modules/video_output/win32/d3d11_deinterlace.c
index 6d3efa9..6be55c6 100644
--- a/modules/video_output/win32/d3d11_deinterlace.c
+++ b/modules/video_output/win32/d3d11_deinterlace.c
@@ -419,6 +419,8 @@ static int Open(vlc_object_t *obj)
 
     sys->procEnumerator  = processorEnumerator;
 
+    InitDeinterlacingContext( &sys->context );
+
     sys->context.settings = p_mode->settings;
     if (sys->context.settings.b_double_rate)
         sys->context.pf_render_ordered = RenderPic;
@@ -433,8 +435,6 @@ static int Open(vlc_object_t *obj)
        goto error;
     }
 
-    InitDeinterlacingContext( &sys->context );
-
     filter->fmt_out.video   = out_fmt;
     filter->pf_video_filter = Deinterlace;
     filter->pf_flush        = Flush;
diff --git a/modules/video_output/win32/dxva2_deinterlace.c b/modules/video_output/win32/dxva2_deinterlace.c
index 23bbdb8..520fc29 100644
--- a/modules/video_output/win32/dxva2_deinterlace.c
+++ b/modules/video_output/win32/dxva2_deinterlace.c
@@ -357,6 +357,8 @@ static int Open(vlc_object_t *obj)
     sys->d3d9_dll     = d3d9_dll;
     sys->decoder_caps = best_caps;
 
+    InitDeinterlacingContext( &sys->context );
+
     sys->context.settings = p_mode->settings;
     sys->context.settings.b_use_frame_history = best_caps.NumBackwardRefSamples != 0 ||
                                        best_caps.NumForwardRefSamples  != 0;
@@ -374,8 +376,6 @@ static int Open(vlc_object_t *obj)
        goto error;
     }
 
-    InitDeinterlacingContext( &sys->context );
-
     filter->fmt_out.video   = out_fmt;
     filter->pf_video_filter = Deinterlace;
     filter->pf_flush        = Flush;
-- 
2.10.1.windows.1

