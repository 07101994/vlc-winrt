From 60e90ada2a4153c3d2647cf6b2067a0dc59cb619 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Wed, 6 Apr 2016 17:30:59 +0200
Subject: [PATCH 1/3] contrib: gnutls: Use CertOpenStore instead of
 CertOpenSystemStore on winrt

---
 contrib/src/gnutls/gnutls-winrt.patch | 16 ++++++++++++++++
 contrib/src/gnutls/rules.mak          |  3 +++
 2 files changed, 19 insertions(+)
 create mode 100644 contrib/src/gnutls/gnutls-winrt.patch

diff --git a/contrib/src/gnutls/gnutls-winrt.patch b/contrib/src/gnutls/gnutls-winrt.patch
new file mode 100644
index 0000000..788358b
--- /dev/null
+++ b/contrib/src/gnutls/gnutls-winrt.patch
@@ -0,0 +1,16 @@
+--- gnutls/lib/system.c.orig2	2016-04-05 11:14:43.364389441 +0200
++++ gnutls/lib/system.c	2016-04-05 11:20:18.535618044 +0200
+@@ -429,9 +429,11 @@
+ 		gnutls_datum_t data;
+ 
+ 		if (i == 0)
+-			store = CertOpenSystemStore(0, "ROOT");
++			store = CertOpenStore(CERT_STORE_PROV_SYSTEM_A, X509_ASN_ENCODING, 0, 
++                        CERT_SYSTEM_STORE_CURRENT_USER, TEXT("ROOT"));
+ 		else
+-			store = CertOpenSystemStore(0, "CA");
++			store = CertOpenStore(CERT_STORE_PROV_SYSTEM_A, X509_ASN_ENCODING, 0, 
++                        CERT_SYSTEM_STORE_CURRENT_USER, TEXT("CA"));
+ 
+ 		if (store == NULL)
+ 			return GNUTLS_E_FILE_ERROR;
diff --git a/contrib/src/gnutls/rules.mak b/contrib/src/gnutls/rules.mak
index 05f917d..d9b5bc4 100644
--- a/contrib/src/gnutls/rules.mak
+++ b/contrib/src/gnutls/rules.mak
@@ -22,6 +22,9 @@ gnutls: gnutls-$(GNUTLS_VERSION).tar.xz .sum-gnutls
 ifdef HAVE_WIN32
 	$(APPLY) $(SRC)/gnutls/gnutls-win32.patch
 	$(APPLY) $(SRC)/gnutls/gnutls-mingw64.patch
+ifdef HAVE_WINRT
+	$(APPLY) $(SRC)/gnutls/gnutls-winrt.patch
+endif
 endif
 ifdef HAVE_ANDROID
 	$(APPLY) $(SRC)/gnutls/no-create-time-h.patch
-- 
2.8.1

