From 99e590cea72cc53daa4cd438805554c277943368 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Tue, 21 Jun 2016 11:07:05 +0200
Subject: [PATCH 11/11] contribs: libarchive: Properly check for fork()

---
 contrib/src/libarchive/properly-check-fork.patch | 17 +++++++++++++++++
 contrib/src/libarchive/rules.mak                 |  1 +
 2 files changed, 18 insertions(+)
 create mode 100644 contrib/src/libarchive/properly-check-fork.patch

diff --git a/contrib/src/libarchive/properly-check-fork.patch b/contrib/src/libarchive/properly-check-fork.patch
new file mode 100644
index 0000000..617e159
--- /dev/null
+++ b/contrib/src/libarchive/properly-check-fork.patch
@@ -0,0 +1,17 @@
+--- libarchive/libarchive/filter_fork_windows.c.orig	2016-06-20 19:24:11.105360670 +0200
++++ libarchive/libarchive/filter_fork_windows.c	2016-06-20 19:25:04.049377660 +0200
+@@ -25,7 +25,7 @@
+ 
+ #include "archive_platform.h"
+ 
+-#if defined(_WIN32) && !defined(__CYGWIN__)
++#if defined(_WIN32) && defined(HAVE_FORK)
+ #include "archive_cmdline_private.h"
+ #include "archive_string.h"
+ 
+@@ -187,4 +187,4 @@
+ 	Sleep(100);
+ }
+ 
+-#endif /* _WIN32 && !__CYGWIN__ */
++#endif /* _WIN32 && HAVE_FORK */
diff --git a/contrib/src/libarchive/rules.mak b/contrib/src/libarchive/rules.mak
index 31b8d38..901ecf8 100644
--- a/contrib/src/libarchive/rules.mak
+++ b/contrib/src/libarchive/rules.mak
@@ -15,6 +15,7 @@ $(TARBALLS)/libarchive-$(LIBARCHIVE_VERSION).tar.gz:
 libarchive: libarchive-$(LIBARCHIVE_VERSION).tar.gz .sum-libarchive
 	$(UNPACK)
 	$(APPLY) $(SRC)/libarchive/0001-Fix-build-failure-without-STATVFS.patch
+	$(APPLY) $(SRC)/libarchive/properly-check-fork.patch
 	$(MOVE)
 
 .libarchive: libarchive
-- 
2.8.1

