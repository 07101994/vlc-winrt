From 0d4b486bc9d3f7c6476e007e6f584b791dd58072 Mon Sep 17 00:00:00 2001
From: Steve Lhomme <robux4@videolabs.io>
Date: Wed, 15 Jun 2016 09:33:36 +0200
Subject: [PATCH] contrib: ffmpeg: fix a deadlock in d3d11va

---
 ...-t-keep-the-context-lock-while-waiting-fo.patch | 40 ++++++++++++++++++++++
 ...-the-context-lock-while-waiting-fo.patch.ffmpeg | 40 ++++++++++++++++++++++
 contrib/src/ffmpeg/rules.mak                       |  1 +
 3 files changed, 81 insertions(+)
 create mode 100644 contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch
 create mode 100644 contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch.ffmpeg

diff --git a/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch b/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch
new file mode 100644
index 0000000..4683262
--- /dev/null
+++ b/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch
@@ -0,0 +1,40 @@
+From 1a2923eef704f019b94a6edf8e9502c2ab1768ef Mon Sep 17 00:00:00 2001
+From: Steve Lhomme <robux4@videolabs.io>
+Date: Wed, 15 Jun 2016 09:23:45 +0200
+Subject: [PATCH] d3d11va: don't keep the context lock while waiting for a
+ frame
+MIME-Version: 1.0
+Content-Type: text/plain; charset=UTF-8
+Content-Transfer-Encoding: 8bit
+
+also fixes a deadlock found by Денис Кулаков <kudesnik33ra@gmail.com>
+---
+ libavcodec/dxva2.c | 12 +++++++++---
+ 1 file changed, 9 insertions(+), 3 deletions(-)
+
+diff --git a/libavcodec/dxva2.c b/libavcodec/dxva2.c
+index 8b0e686..9157094 100644
+--- a/libavcodec/dxva2.c
++++ b/libavcodec/dxva2.c
+@@ -158,9 +158,15 @@ int ff_dxva2_common_end_frame(AVCodecContext *avctx, AVFrame *frame,
+                                                  ff_dxva2_get_surface(frame),
+                                                  NULL);
+ #endif
+-        if (hr == E_PENDING)
+-            av_usleep(2000);
+-    } while (hr == E_PENDING && ++runs < 50);
++        if (hr != E_PENDING || ++runs > 50)
++            break;
++#if CONFIG_D3D11VA
++        if (avctx->pix_fmt == AV_PIX_FMT_D3D11VA_VLD)
++            if (D3D11VA_CONTEXT(ctx)->context_mutex != INVALID_HANDLE_VALUE)
++                ReleaseMutex(D3D11VA_CONTEXT(ctx)->context_mutex);
++#endif
++        av_usleep(2000);
++    } while(1);
+ 
+     if (FAILED(hr)) {
+         av_log(avctx, AV_LOG_ERROR, "Failed to begin frame: 0x%lx\n", hr);
+-- 
+2.7.2.windows.1
+
diff --git a/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch.ffmpeg b/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch.ffmpeg
new file mode 100644
index 0000000..35a64fa
--- /dev/null
+++ b/contrib/src/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch.ffmpeg
@@ -0,0 +1,40 @@
+From 9a48d42e16be73f9fe724273416ede2a9e59b300 Mon Sep 17 00:00:00 2001
+From: Steve Lhomme <robux4@videolabs.io>
+Date: Wed, 15 Jun 2016 09:22:55 +0200
+Subject: [PATCH] d3d11va: don't keep the context lock while waiting for a
+ frame
+MIME-Version: 1.0
+Content-Type: text/plain; charset=UTF-8
+Content-Transfer-Encoding: 8bit
+
+also fixes a deadlock found by Денис Кулаков <kudesnik33ra@gmail.com>
+---
+ libavcodec/dxva2.c | 12 +++++++++---
+ 1 file changed, 9 insertions(+), 3 deletions(-)
+
+diff --git a/libavcodec/dxva2.c b/libavcodec/dxva2.c
+index 2cf57ad..f68df86 100644
+--- a/libavcodec/dxva2.c
++++ b/libavcodec/dxva2.c
+@@ -158,9 +158,15 @@ int ff_dxva2_common_end_frame(AVCodecContext *avctx, AVFrame *frame,
+                                                  ff_dxva2_get_surface(frame),
+                                                  NULL);
+ #endif
+-        if (hr == E_PENDING)
+-            av_usleep(2000);
+-    } while (hr == E_PENDING && ++runs < 50);
++        if (hr != E_PENDING || ++runs > 50)
++            break;
++#if CONFIG_D3D11VA
++        if (avctx->pix_fmt == AV_PIX_FMT_D3D11VA_VLD)
++            if (D3D11VA_CONTEXT(ctx)->context_mutex != INVALID_HANDLE_VALUE)
++                ReleaseMutex(D3D11VA_CONTEXT(ctx)->context_mutex);
++#endif
++        av_usleep(2000);
++    } while(1);
+ 
+     if (FAILED(hr)) {
+         av_log(avctx, AV_LOG_ERROR, "Failed to begin frame: 0x%lx\n", hr);
+-- 
+2.7.2.windows.1
+
diff --git a/contrib/src/ffmpeg/rules.mak b/contrib/src/ffmpeg/rules.mak
index 85af0c5..7a85881 100644
--- a/contrib/src/ffmpeg/rules.mak
+++ b/contrib/src/ffmpeg/rules.mak
@@ -212,6 +212,7 @@ ffmpeg: ffmpeg-$(HASH).tar.xz .sum-ffmpeg
 	rm -Rf $@ $@-$(HASH)
 	mkdir -p $@-$(HASH)
 	$(XZCAT) "$<" | (cd $@-$(HASH) && tar xv --strip-components=1)
+	$(APPLY) $(SRC)/ffmpeg/0001-d3d11va-don-t-keep-the-context-lock-while-waiting-fo.patch$(PATCH_SUFFIX)
 ifdef HAVE_VISUALSTUDIO
 	$(APPLY) $(SRC)/ffmpeg/msvc.patch$(PATCH_SUFFIX)
 	$(APPLY) $(SRC)/ffmpeg/near_field.patch$(PATCH_SUFFIX)
